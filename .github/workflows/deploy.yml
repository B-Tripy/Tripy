name: deploy

on:
  push:
    branches: ["master"]
    paths:
      - "backend/**" # 백엔드 코드 수정 시
      - "frontend/**" # 프론트엔드 코드 수정 시
      - "docker-compose.yml" # 설정 파일 수정 시 실행

jobs:
  # [직무 1] 도커 이미지 만들어서 허브에 올리기
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      # 도커 허브 로그인
      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # 도커 빌드 도구 세팅
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      # [프론트엔드] 빌드 & 푸시
      - name: Build and Push Frontend
        uses: docker/build-push-action@v4
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          push: true
          # docker-compose.yml에 적은 이미지 이름과 똑같아야 함
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/tripy-nginx:latest

      # [백엔드] 빌드 & 푸시
      - name: Build and Push Backend
        uses: docker/build-push-action@v4
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/tripy-node:latest

  # [직무 2] AWS 서버에 접속해서 새 이미지로 갈아끼우기
  deploy:
    needs: build-and-deploy # 위 단계가 성공해야만 실행됨
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to EC2
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: ${{ secrets.EC2_PORT }}
          script: |
            # 1. 프로젝트 폴더로 이동
            cd /home/ubuntu/Tripy

            # 2. 최신 docker-compose.yml 파일 받기
            git pull origin master

            # 3. 도커 허브 로그인 (혹시 모를 권한 문제 방지)
            echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin

            # 4. 네트워크 생성 (external: true 설정 대비)
            docker network create tripyserver || true

            # 5. 최신 이미지 다운로드 (Pull)
            docker-compose pull

            # 6. 서버 재실행 (기존 거 끄고 새 거 켬)
            docker-compose up -d --remove-orphans

            # 7. 안 쓰는 옛날 이미지 삭제 (용량 확보)
            docker image prune -f
